name: Diff DBM test output
description: Runs DBM tests on two commits and pushes the resulting output into a repository to get a diff
branding:
  icon: book
  color: blue

inputs:
  game-flavor:
    required: true
  dbm-offline-repo:
    default: DeadlyBossMods/DBM-Offline
  dbm-offline-ref:
    default: ""
  dbm-main-repo:
    default: DeadlyBossMods/DeadlyBossMods
  dbm-main-ref:
    default: ""
  dbm-main-base-ref:
    default: ""
  dbm-mod-repo:
    required: true
  dbm-mod-ref:
    default: ""
    required: true
  dbm-mod-base-ref:
    default: ""
    required: true
  upload-repo:
    required: true
  upload-token:
    required: true
  comment-token:
    required: true

runs:
  using: composite
  steps:
    - name: Setup and DBM-Offline dependencies
      shell: bash
      run: |
        mkdir -p dbm-offline-diff
        export DEBIAN_FRONTEND=noninteractive
        sudo apt-get update
        sudo apt-get install -y lua5.1 luarocks subversion
        sudo luarocks --lua-version 5.1 install bitlib
        sudo luarocks --lua-version 5.1 install luafilesystem
    - name: Checkout DBM-Offline
      uses: actions/checkout@v4
      with:
        repository: ${{ inputs.dbm-offline-repo }}
        ref: ${{ inputs.dbm-offline-ref }}
        path: ./dbm-offline-diff/DBM-Offline
    - name: Checkout DBM main repo
      uses: actions/checkout@v4
      with:
        repository: ${{ inputs.dbm-main-repo }}
        ref: ${{ inputs.dbm-main-ref }}
        path: ./dbm-offline-diff/DeadlyBossMods
    - name: Checkout DBM main repo (base)
      uses: actions/checkout@v4
      with:
        repository: ${{ inputs.dbm-main-repo }}
        ref: ${{ inputs.dbm-main-base-ref }}
        path: ./dbm-offline-diff/DeadlyBossMods-base
    - name: Download DBM dependencies
      uses: BigWigsMods/packager@master
      with:
        args: -z -d -c -t ./dbm-offline-diff/DeadlyBossMods
    - name: Install DBM dependencies
      shell: bash
      run: |
        cp -r ./dbm-offline-diff/DeadlyBossMods/.release/DBM-Core/Libs ./dbm-offline-diff/DeadlyBossMods/DBM-Core/
        # FIXME: this is slightly incorrect and won't work if a dependency was removed
        cp -r ./dbm-offline-diff/DeadlyBossMods/.release/DBM-Core/Libs ./dbm-offline-diff/DeadlyBossMods-base/DBM-Core/
    - name: Checkout DBM mod repo
      uses: actions/checkout@v4
      with:
        repository: ${{ inputs.dbm-mod-repo }}
        ref: ${{ inputs.dbm-mod-ref }}
        path: ./dbm-offline-diff/mod-repo
    - name: Checkout DBM mod repo (base)
      uses: actions/checkout@v4
      with:
        repository: ${{ inputs.dbm-mod-repo }}
        ref: ${{ inputs.dbm-mod-base-ref }}
        path: ./dbm-offline-diff/mod-repo-base
    - name: Run tests
      shell: bash
      run: |
        cd dbm-offline-diff/DBM-Offline
        lua5.1 main.lua --flavor ${{ inputs.game-flavor }} --dbm ../DeadlyBossMods --mods ../mod-repo
        mkdir -p ../results
        mv reports ../results/new
    - name: Run tests (Base)
      shell: bash
      run: |
        cd dbm-offline-diff/DBM-Offline
        lua5.1 main.lua --flavor ${{ inputs.game-flavor }} --dbm ../DeadlyBossMods-base --mods ../mod-repo-base
        mkdir -p ../results
        mv reports ../results/base
    - name: Upload reports
      id: upload
      shell: bash
      run: |
        cd dbm-offline-diff/DBM-Offline
        lua5.1 diff.lua ../results/base ../results/new > ../summary.txt
        cd ..
        mkdir upload-results
        cd upload-results
        git init .
        git config --global user.email "ci@deadlybossmods.com"
        git config --global user.name "DBM CI"
        git checkout -b diff-dbm-${{ inputs.dbm-main-base-ref }}-${{ inputs.dbm-main-ref }}-mod-${{ inputs.dbm-mod-base-ref }}-${{ inputs.dbm-mod-ref }}
        mv ../results/base reports
        rm -f reports/.gitignore
        git add reports/*
        git commit -am "Test results at https://github.com/${{ inputs.dbm-main-repo }}/commit/${{ inputs.dbm-main-base-ref }} with https://github.com/${{ inputs.dbm-mod-repo }}/commit/${{ inputs.dbm-mod-base-ref }}"
        rm -rf reports/
        mv ../results/new reports
        rm -f reports/.gitignore
        git add reports/*
        git commit --allow-empty -am "Test results at https://github.com/${{ inputs.dbm-main-repo }}/commit/${{ inputs.dbm-main-ref }} with https://github.com/${{ inputs.dbm-mod-repo }}/commit/${{ inputs.dbm-mod-ref }}"
        git push https://${gh_token}@github.com/${{ inputs.upload-repo }} diff-dbm-${{ inputs.dbm-main-base-ref }}-${{ inputs.dbm-main-ref }}-mod-${{ inputs.dbm-mod-base-ref }}-${{ inputs.dbm-mod-ref }}
        sed -i "s|{{fullDiffLink}}|https://github.com/${{ inputs.upload-repo }}/commit/$(git rev-parse HEAD)|" ../summary.txt
        echo 'diff<<EOFDelim' >> $GITHUB_OUTPUT
        cat ../summary.txt >> $GITHUB_OUTPUT
        echo EOFDelim >> $GITHUB_OUTPUT
        cat ../summary.txt >> $GITHUB_STEP_SUMMARY
      env:
        gh_token: ${{ inputs.upload-token }}
    - name: Cleanup
      shell: bash
      if: always()
      run: |
        # just making sure the auth token is definitely gone
        rm -rf dbm-offline-diff/upload-results/.git
    - name: Post comment
      uses: actions/github-script@v5
      with:
        github-token: ${{ inputs.comment-token }}
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `${{ steps.upload.outputs.diff }}`
          })
